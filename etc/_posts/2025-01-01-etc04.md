---
layout: post
title: etc04
sitemap: false
hide_last_modified: true
---
# MVCC

* toc
{:toc .large-only}

# 다중 버전 동시성 제어
다중 버전 동시성 제어`MVCC(Multi-Version Concurrency Control)`란, DBMS의 동시성 제어 메커니즘으로 트랜잭션 격리 수준을 구현하는 방법 중 하나이다.
MVCC는 `스냅샷`과 `버전`이라는 개념으로 데이터베이스의 동시성과 일관성을 유지한다.

- 스냅샷: 트랜잭션 시작 시 `그 순간의 데이터 상태`를 기억해두는 것. 같은 조회 결과를 보장해주는 도구. 트랜잭션 격리 수준에 따라 다르게 동작
- 버전: 각 행이 `언제 만들어졌고, 언제 삭제되었는가`를 나타내는 정보. 트랜잭션이 해당 행을 읽을 수 있는지 판단하는데 사용됨

간단히 설명하자면 `스냅샷`은 내가 트랜잭션 시작 할 때 본 `DB상태`이고, `버전`은 데이터 변경 이력을 뜻한다.  

## MVCC의 동작
MVCC는 트랜잭션마다 스냅샷을 유지하고, 각 행의 버전을 관리함으로써 동시 접근 시 충돌 없이 읽기와 쓰기를 가능하게 한다.
대표적으로 MySQL(InnoDB), PostgreSQL, Oracle 등에서 사용되며, MyISAM과 같은 일부 엔진에서는 지원되지 않는다.

> MySQL 엔진 (InnoDB / MyISAM): 데이터를 저장하고 관리하는 방식을 정의하는 MySQL의 구성요소 (일종의 정책).  
> 테이블 생성 시 엔진을 명시적으로 설정 가능.

### 참고
- Dirty Read: 커밋되지 않은 데이터를 읽음
- Unrepeatable Read: 데이터 반복 조회 시 다른 트랜잭션에서 값을 수정하여 조회 값이 달라짐(다른 트랜잭션에서 데이터가 수정됨)

[트랜잭션 이상현상](https://xxyoonxx.github.io/etc/2024-12-30-etc03/#%EC%A3%BC%EC%9A%94-%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98-%EC%9D%B4%EC%83%81)

## 장점
- 읽기 - 쓰기의 동시성 보장
  - 읽기 작업 시 별도의 스냅샷을 참조하므로 하나의 트랜잭션이 쓰기 작업이 진행 중이어도 다른 트랜잭션이 읽기 작업 가능.
- 교착 상태를 방지
  - MVCC가 없다면 락 기반으로 이를 제어하게 되는데 단순 조회라도 다른 트랜잭션의 작업을 기다려야한다. 때문에 동시성이 낮아지고 교착상태가 발생 할 수 있으며 성능이 떨어진다.
- 데이터 작업 중 값이 수정되지 않음
  - 각자의 스냅샷을 가지고 독립적인 공간에서 작업하므로 내가 작업하는 동안 다른 트랜잭션이 데이터를 수정해서 커밋해도, 내 트랜잭션에서는 여전히 기존 값을 반환한다.
  - 실시간으로 변동되는 정보 중 일부를 가지고 작업 할 때 유리(주식 구매와 같은 실시간 금융 거래 시스템 등)

## 단점
- 데이터의 버전이 여러 개 생길 경우 스토리지 사용량 증가
- 스냅샷 기반으로 작업하므로 다른 트랜잭션이 작업한 최신 데이터의 반영이 지연 될 수 있음
- 여러 트랜잭션이 같은 데이터 수정 시 커밋이 늦은 트랜잭션에서 롤백이 발생하므로 성능 저하 가능성 있음

## 트랜잭션 격리 수준과 MVCC의 관계
MVCC는 트랜잭션 격리 수준에 따라 스냅샷 생성 시점과 데이터 접근 방식을 조정한다.  
트랜잭션 격리 수준이 높아질 수록 MVCC가 더 많은 제약을 적용하게 된다.